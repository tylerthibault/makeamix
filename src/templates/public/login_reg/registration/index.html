{% extends 'bases/public.html' %}

{% block head %}
<meta name="description" content="Join MakeAMix - Create your account to start mixing music, creating beats, and sharing your creations with the world.">
<meta name="keywords" content="register, signup, music mixing, DJ, beats, MakeAMix, create account">
{% endblock head %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/auth.css') }}">
{% endblock css %}

{% block content %}
<section class="auth-register min-vh-100 d-flex align-items-center position-relative py-5">
    <!-- Background Elements -->
    <div class="auth-bg-elements">
        <div class="auth-particle auth-particle-1"></div>
        <div class="auth-particle auth-particle-2"></div>
        <div class="auth-particle auth-particle-3"></div>
        <div class="auth-particle auth-particle-4"></div>
        <div class="auth-particle auth-particle-5"></div>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="auth-card bg-white rounded-4 shadow-lg p-5 position-relative">
                    <!-- Music Theme Header -->
                    <div class="text-center mb-4">
                        <div class="auth-logo-container bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3">
                            <i class="bi bi-person-plus text-white"></i>
                        </div>
                        <h1 class="h3 fw-bold text-dark mb-2">Join MakeAMix</h1>
                        <p class="text-muted">Create your account and start mixing music</p>
                    </div>

                    <!-- Registration Form -->
                    <form class="auth-form" method="POST" action="{{ url_for('user.register') }}" id="registrationForm">
                        <!-- CSRF Token (if available) -->
                        {% if csrf_token %}
                            {{ csrf_token() }}
                        {% endif %}
                        
                        <!-- Registration Form -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label fw-semibold text-dark">
                                    <i class="bi bi-person me-2 text-primary"></i>First Name
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg auth-input" 
                                       id="first_name" 
                                       name="first_name" 
                                       placeholder="Enter your first name"
                                       required
                                       minlength="2"
                                       maxlength="50"
                                       value="{{ request.form.first_name if request.form.first_name }}">
                                {% if errors and errors.first_name %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{ errors.first_name }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label fw-semibold text-dark">
                                    <i class="bi bi-person me-2 text-primary"></i>Last Name
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg auth-input" 
                                       id="last_name" 
                                       name="last_name" 
                                       placeholder="Enter your last name"
                                       required
                                       minlength="2"
                                       maxlength="50"
                                       value="{{ request.form.last_name if request.form.last_name }}">
                                {% if errors and errors.last_name %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{ errors.last_name }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Email Field -->
                        <div class="mb-4">
                            <label for="email" class="form-label fw-semibold text-dark">
                                <i class="bi bi-envelope me-2 text-primary"></i>Email Address
                            </label>
                            <input type="email" 
                                   class="form-control form-control-lg auth-input" 
                                   id="email" 
                                   name="email" 
                                   placeholder="Enter your email address"
                                   required
                                   maxlength="120"
                                   value="{{ request.form.email if request.form.email }}">
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>We'll use this to send you important updates
                            </div>
                            {% if errors and errors.email %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ errors.email }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Password Fields -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="password" class="form-label fw-semibold text-dark">
                                    <i class="bi bi-shield-lock me-2 text-primary"></i>Password
                                </label>
                                <div class="position-relative">
                                    <input type="password" 
                                           class="form-control form-control-lg auth-input" 
                                           id="password" 
                                           name="password" 
                                           placeholder="Create a password"
                                           required
                                           minlength="8">
                                    <button type="button" 
                                            class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-3 auth-password-toggle"
                                            onclick="togglePassword('password')">
                                        <i class="bi bi-eye text-muted" id="passwordToggleIcon"></i>
                                    </button>
                                </div>
                                {% if errors and errors.password %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{ errors.password }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="confirm_password" class="form-label fw-semibold text-dark">
                                    <i class="bi bi-shield-check me-2 text-primary"></i>Confirm Password
                                </label>
                                <div class="position-relative">
                                    <input type="password" 
                                           class="form-control form-control-lg auth-input" 
                                           id="confirm_password" 
                                           name="confirm_password" 
                                           placeholder="Confirm your password"
                                           required
                                           minlength="8">
                                    <button type="button" 
                                            class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-3 auth-password-toggle"
                                            onclick="togglePassword('confirm_password')">
                                        <i class="bi bi-eye text-muted" id="confirmPasswordToggleIcon"></i>
                                    </button>
                                </div>
                                {% if errors and errors.confirm_password %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{ errors.confirm_password }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Password Requirements -->
                        <div class="password-requirements mb-4">
                            <small class="text-muted">Password must contain:</small>
                            <ul class="list-unstyled mt-2">
                                <li class="requirement" id="req-length">
                                    <i class="bi bi-x-circle text-danger me-2" id="req-length-icon"></i>
                                    <small>At least 8 characters</small>
                                </li>
                                <li class="requirement" id="req-match">
                                    <i class="bi bi-x-circle text-danger me-2" id="req-match-icon"></i>
                                    <small>Passwords must match</small>
                                </li>
                            </ul>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
                                <label class="form-check-label text-muted" for="terms">
                                    I agree to the 
                                    <a href="#" class="text-primary text-decoration-none">Terms of Service</a> 
                                    and 
                                    <a href="#" class="text-primary text-decoration-none">Privacy Policy</a>
                                </label>
                            </div>
                            {% if errors and errors.terms %}
                                <div class="invalid-feedback d-block">
                                    <i class="bi bi-exclamation-circle me-1"></i>{{ errors.terms }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Music Updates Opt-in -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="music_updates" name="music_updates" checked>
                                <label class="form-check-label text-muted" for="music_updates">
                                    <i class="bi bi-music-note me-1"></i>
                                    Send me updates about new features and music resources
                                </label>
                            </div>
                        </div>

                        <!-- Error Messages -->
                        {% if error %}
                            <div class="alert alert-danger d-flex align-items-center mb-4">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {{ error }}
                            </div>
                        {% endif %}

                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} d-flex align-items-center mb-4">
                                        <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <!-- Register Button -->
                        <button type="submit" class="btn btn-primary btn-lg w-100 mb-4 auth-submit-btn" id="registerBtn">
                            <i class="bi bi-person-plus me-2"></i>
                            <span class="auth-btn-text">Create Account</span>
                            <div class="auth-btn-loader d-none">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Creating account...
                            </div>
                        </button>
                    </form>

                    <!-- Sign In Link -->
                    <div class="text-center pt-4 border-top">
                        <p class="text-muted mb-0">
                            Already have an account? 
                            <a href="{{ url_for('user.login') }}" class="text-primary text-decoration-none fw-semibold">
                                Sign in here
                            </a>
                        </p>
                    </div>

                    <!-- Music Theme Footer -->
                    <div class="auth-music-footer text-center mt-4">
                        <div class="d-flex justify-content-center align-items-center gap-2 text-muted">
                            <i class="bi bi-music-note"></i>
                            <small>Ready to start creating amazing music?</small>
                            <i class="bi bi-music-note"></i>
                        </div>
                    </div>
                </div>

                <!-- Music Features Info Card -->
                <div class="card border-0 bg-primary text-white mt-4">
                    <div class="card-body text-center p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="bi bi-music-note-beamed fs-1 mb-2 opacity-75"></i>
                                    <h6 class="fw-semibold mb-1">Create Mixes</h6>
                                    <small class="opacity-75">Mix and create amazing music tracks</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="bi bi-headphones fs-1 mb-2 opacity-75"></i>
                                    <h6 class="fw-semibold mb-1">Listen & Share</h6>
                                    <small class="opacity-75">Enjoy your creations and share with friends</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="bi bi-soundwave fs-1 mb-2 opacity-75"></i>
                                    <h6 class="fw-semibold mb-1">Learn & Grow</h6>
                                    <small class="opacity-75">Develop your music production skills</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block js %}
<script>
// Password visibility toggle
function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const toggleIcon = document.getElementById(fieldId + 'ToggleIcon') || document.getElementById('passwordToggleIcon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.className = 'bi bi-eye-slash text-muted';
    } else {
        passwordField.type = 'password';
        toggleIcon.className = 'bi bi-eye text-muted';
    }
}

// Password validation
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm_password');
    const lengthReq = document.getElementById('req-length');
    const lengthIcon = document.getElementById('req-length-icon');
    const matchReq = document.getElementById('req-match');
    const matchIcon = document.getElementById('req-match-icon');
    const registerBtn = document.getElementById('registerBtn');
    
    function validatePassword() {
        const password = passwordField.value;
        const confirmPassword = confirmPasswordField.value;
        let isValid = true;
        
        // Length requirement
        if (password.length >= 8) {
            lengthIcon.className = 'bi bi-check-circle text-success me-2';
            lengthReq.classList.remove('text-danger');
            lengthReq.classList.add('text-success');
        } else {
            lengthIcon.className = 'bi bi-x-circle text-danger me-2';
            lengthReq.classList.remove('text-success');
            lengthReq.classList.add('text-danger');
            isValid = false;
        }
        
        // Match requirement
        if (password && confirmPassword && password === confirmPassword) {
            matchIcon.className = 'bi bi-check-circle text-success me-2';
            matchReq.classList.remove('text-danger');
            matchReq.classList.add('text-success');
        } else if (confirmPassword) {
            matchIcon.className = 'bi bi-x-circle text-danger me-2';
            matchReq.classList.remove('text-success');
            matchReq.classList.add('text-danger');
            isValid = false;
        }
        
        // Enable/disable register button
        registerBtn.disabled = !isValid;
        
        return isValid;
    }
    
    passwordField.addEventListener('input', validatePassword);
    confirmPasswordField.addEventListener('input', validatePassword);
});

// Form submission handling
document.getElementById('registrationForm').addEventListener('submit', function(e) {
    const registerBtn = document.getElementById('registerBtn');
    const btnText = registerBtn.querySelector('.auth-btn-text');
    const btnLoader = registerBtn.querySelector('.auth-btn-loader');
    
    // Show loading state
    btnText.classList.add('d-none');
    btnLoader.classList.remove('d-none');
    registerBtn.disabled = true;
    
    // Re-enable if there's an error (handled by page reload)
    setTimeout(() => {
        btnText.classList.remove('d-none');
        btnLoader.classList.add('d-none');
        registerBtn.disabled = false;
    }, 5000);
});
</script>
{% endblock js %}
