{% extends 'bases/public.html' %}

{% block content %}
<div class="container">
    <div class="header">
        <div class="header-top-row">
            <h1>{{ playlist.name }}</h1>
            <button class="btn btn-login" onclick="location.href='{{ url_for('auth.login') }}'">Login</button>
        </div>
        <p class="tagline">{{ songs|length }} songs â€¢ Created by {{ playlist.user.username }}</p>
        <div class="header-actions">
            {% if songs %}
            <button onclick="playPlaylist()" class="btn btn-primary" title="Play all songs">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Play All
            </button>
            {% endif %}
            <button id="share-btn" class="btn btn-secondary" title="Share this playlist">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                Share
            </button>
        </div>
    </div>

    {% if playlist.description %}
    <div class="content-section">
        <h2>About</h2>
        <p style="color: var(--color-text-secondary); line-height: 1.6;">{{ playlist.description }}</p>
    </div>
    {% endif %}

    <div class="content-section">
        <h2>Songs</h2>
        
        {% if songs %}
        <div class="playlist-songs">
            {% for song in songs %}
            <div class="playlist-song-item">
                <div class="song-info">
                    <h4>{{ song.title }}</h4>
                    <p>Uploaded {{ song.created_at.strftime('%b %d, %Y') }}</p>
                </div>
                <div class="song-actions">
                    <a href="{{ url_for('songs.view_song', song_id=song.id) }}" class="btn btn-sm btn-primary">Play</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            This playlist is empty.
        </div>
        {% endif %}
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Share Playlist</h2>
            <button class="modal-close" id="close-share-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="share-section">
                <h3>QR Code</h3>
                <div id="qr-code" class="qr-code-container"></div>
                <p class="form-help-text">Scan this QR code to share the playlist</p>
            </div>
            
            <div class="share-section">
                <h3>Share Link</h3>
                <div class="share-link-container">
                    <input type="text" id="share-link" readonly value="{{ request.url }}">
                    <button id="copy-link-btn" class="btn btn-primary">Copy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// Play entire playlist function
window.playPlaylist = function() {
    console.log('Play Playlist clicked');
    const playlistSongs = [
        {% for song in songs %}
        {
            id: {{ song.id }},
            title: {{ song.title|tojson }},
            url: "{{ url_for('songs.view_song', song_id=song.id) }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    console.log('Playlist songs:', playlistSongs);
    
    if (!window.queueManager) {
        console.error('queueManager not available!');
        alert('Queue system not loaded. Please refresh the page.');
        return;
    }
    
    if (playlistSongs.length > 0) {
        console.log('Replacing queue with', playlistSongs.length, 'songs');
        queueManager.replaceQueue(playlistSongs, 0);
    } else {
        console.log('No songs to play');
        alert('This playlist is empty!');
    }
};

// Share functionality
const shareBtn = document.getElementById('share-btn');
const shareModal = document.getElementById('share-modal');
const closeShareModal = document.getElementById('close-share-modal');
const copyLinkBtn = document.getElementById('copy-link-btn');
const shareLinkInput = document.getElementById('share-link');
let qrCodeGenerated = false;

shareBtn.addEventListener('click', () => {
    shareModal.style.display = 'flex';
    
    // Generate QR code only once
    if (!qrCodeGenerated) {
        const qrContainer = document.getElementById('qr-code');
        qrContainer.innerHTML = ''; // Clear any existing content
        new QRCode(qrContainer, {
            text: window.location.href,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
        qrCodeGenerated = true;
    }
});

closeShareModal.addEventListener('click', () => {
    shareModal.style.display = 'none';
});

// Close modal when clicking outside
shareModal.addEventListener('click', (e) => {
    if (e.target === shareModal) {
        shareModal.style.display = 'none';
    }
});

copyLinkBtn.addEventListener('click', () => {
    shareLinkInput.select();
    document.execCommand('copy');
    
    const originalText = copyLinkBtn.textContent;
    copyLinkBtn.textContent = 'Copied!';
    copyLinkBtn.classList.add('btn-success');
    
    setTimeout(() => {
        copyLinkBtn.textContent = originalText;
        copyLinkBtn.classList.remove('btn-success');
    }, 2000);
});
</script>
{% endblock content %}